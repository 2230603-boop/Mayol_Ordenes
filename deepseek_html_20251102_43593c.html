<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Mayol Sistema De Ordenes</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <img src="https://via.placeholder.com/150x80/2c3e50/ffffff?text=MAYOL" alt="Logo Mayol" class="login-logo">
            <h2>ğ’ğ¢ğ¬ğ­ğğ¦ğš ğƒğ ğğ«ğğğ§ğğ¬ ğğ«ğ¨ğğ®ğœğœğ¢Ã³ğ§ ğ² ğğ«ğ¨ğœğğ¬ğ¨</h2>
        </div>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group password-group">
                <label for="password">ContraseÃ±a:</label>
                <div class="password-input-container">
                    <input type="password" id="password" required>
                    <button type="button" class="toggle-password" id="togglePassword">
                        ğŸ‘ï¸
                    </button>
                </div>
            </div>
            <button type="submit" class="btn-login">Iniciar SesiÃ³n</button>
            <div class="remember-me">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Recordar mi sesiÃ³n</label>
            </div>
        </form>
    </div>

    <!-- Resto del cÃ³digo del sistema se mantiene igual -->
    <!-- Sistema Principal (oculto inicialmente) -->
    <div id="mainSystem" class="container hidden">
        <!-- ... (todo el contenido del sistema principal se mantiene igual) ... -->
    </div>

    <script>
        // CONFIGURACIÃ“N DE FIREBASE (se mantiene igual)
        const firebaseConfig = {
            apiKey: "AIzaSyB1ywwzR49KiEZC16_rhh9pmw0aMfT8Zxo",
            authDomain: "sistema-de-ordenes-de-trabajo.firebaseapp.com",
            databaseURL: "https://sistema-de-ordenes-de-trabajo-default-rtdb.firebaseio.com",
            projectId: "sistema-de-ordenes-de-trabajo",
            storageBucket: "sistema-de-ordenes-de-trabajo.firebasestorage.app",
            messagingSenderId: "328684805267",
            appId: "1:328684805267:web:ebbd2d1957ad7275ea4166",
            measurementId: "G-SGVGP74MBL"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ğŸ”„ CONTADORES SEPARADOS PARA PRODUCCIÃ“N Y PROCESO
        let contadorProduccion = 1;
        let contadorProceso = 1;

        // FunciÃ³n para cargar contadores desde Firebase
        function cargarContadores() {
            db.ref('contadorProduccion').once('value').then((snapshot) => {
                contadorProduccion = snapshot.val() || 1;
            });
            
            db.ref('contadorProceso').once('value').then((snapshot) => {
                contadorProceso = snapshot.val() || 1;
            });
        }

        // Variables globales
        let ordenes = [];
        let notificaciones = [];
        let currentUser = null;
        let currentRole = null;
        let currentArea = null;
        let ordenEditando = null;

        // Elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const loginForm = document.getElementById('loginForm');
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const rememberMe = document.getElementById('rememberMe');

        // Sistema de autenticaciÃ³n con usuarios especÃ­ficos y permisos unificados
        const usuarios = {
            'RODRIGO': { 
                password: 'produccion_0', 
                role: 'jefe', 
                nombre: 'RODRIGO SAMPERIO', 
                area: 'produccion',
                permisos: ['crear_orden', 'editar_orden', 'gestionar_orden', 'ver_dashboard', 'ver_ordenes', 'ver_notificaciones']
            },
            'EDGAR': { 
                password: 'proceso_0', 
                role: 'jefe', 
                nombre: 'EDGAR', 
                area: 'proceso',
                permisos: ['crear_orden', 'editar_orden', 'gestionar_orden', 'ver_dashboard', 'ver_ordenes', 'ver_notificaciones']
            },
            'BENITO': { 
                password: 'mantenimiento_01', 
                role: 'responsable', 
                nombre: 'BENITO SUAREZ', 
                area: null,
                permisos: ['ver_dashboard', 'ver_ordenes', 'ver_notificaciones', 'cambiar_estado']
            }
        };

        // FUNCIÃ“N PARA VER CONTRASEÃ‘A
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ”’';
        });

        // FUNCIONES DE PERSISTENCIA DE SESIÃ“N
        function guardarSesion(usuario, recordar) {
            if (recordar) {
                localStorage.setItem('sistemaMayol_usuario', usuario);
                localStorage.setItem('sistemaMayol_sesion', 'activa');
            } else {
                sessionStorage.setItem('sistemaMayol_usuario', usuario);
                sessionStorage.setItem('sistemaMayol_sesion', 'activa');
            }
        }

        function verificarSesionActiva() {
            const usuarioLocal = localStorage.getItem('sistemaMayol_usuario');
            const usuarioSession = sessionStorage.getItem('sistemaMayol_usuario');
            
            return usuarioLocal || usuarioSession;
        }

        function obtenerUsuarioGuardado() {
            return localStorage.getItem('sistemaMayol_usuario') || sessionStorage.getItem('sistemaMayol_usuario');
        }

        function cerrarSesionPersistente() {
            localStorage.removeItem('sistemaMayol_usuario');
            localStorage.removeItem('sistemaMayol_sesion');
            sessionStorage.removeItem('sistemaMayol_usuario');
            sessionStorage.removeItem('sistemaMayol_sesion');
        }

        // FUNCIÃ“N PARA INICIAR SESIÃ“N AUTOMÃTICAMENTE SI HAY SESIÃ“N GUARDADA
        function iniciarSesionAutomatica() {
            const usuarioGuardado = obtenerUsuarioGuardado();
            if (usuarioGuardado && usuarios[usuarioGuardado]) {
                // Simular inicio de sesiÃ³n automÃ¡tico
                currentUser = usuarioGuardado;
                currentRole = usuarios[usuarioGuardado].role;
                currentArea = usuarios[usuarioGuardado].area;
                
                // Actualizar interfaz
                document.getElementById('currentUser').textContent = usuarios[usuarioGuardado].nombre;
                document.getElementById('currentRole').textContent = currentRole === 'jefe' ? 
                    (currentArea === 'proceso' ? 'Jefe Proceso' : 'Jefe ProducciÃ³n') : 
                    'Responsable';
                
                if (currentArea === 'proceso') {
                    document.getElementById('currentRole').classList.add('proceso');
                }
                
                cargarContadores();
                
                // Configurar interfaz segÃºn el rol
                if (currentRole === 'responsable') {
                    document.getElementById('tabNuevaOrden').classList.add('hidden');
                } else {
                    document.getElementById('tabNuevaOrden').classList.remove('hidden');
                    cargarFormularioNuevaOrden();
                }
                
                loginScreen.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                
                // Escuchar cambios en tiempo real
                iniciarListenersFirebase();
                
                mostrarNotificacion(`Bienvenido de nuevo ${usuarios[usuarioGuardado].nombre}`, 'info', currentArea);
                return true;
            }
            return false;
        }

        // MODIFICAR EL EVENT LISTENER DEL LOGIN
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim().toUpperCase();
            const password = document.getElementById('password').value;
            const recordar = rememberMe.checked;
            
            if (verificarCredenciales(username, password)) {
                // Guardar sesiÃ³n si el usuario lo desea
                guardarSesion(username, recordar);
                
                currentUser = username;
                currentRole = usuarios[username].role;
                currentArea = usuarios[username].area;
                currentUserSpan.textContent = usuarios[username].nombre;
                currentRoleSpan.textContent = currentRole === 'jefe' ? 
                    (currentArea === 'proceso' ? 'Jefe Proceso' : 'Jefe ProducciÃ³n') : 
                    'Responsable';
                
                if (currentArea === 'proceso') {
                    currentRoleSpan.classList.add('proceso');
                } else {
                    currentRoleSpan.classList.remove('proceso');
                }
                
                cargarContadores();
                
                if (currentRole === 'responsable') {
                    document.getElementById('tabNuevaOrden').classList.add('hidden');
                } else {
                    document.getElementById('tabNuevaOrden').classList.remove('hidden');
                    cargarFormularioNuevaOrden();
                }
                
                loginScreen.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                
                iniciarListenersFirebase();
                
                mostrarNotificacion(`Bienvenido ${usuarios[username].nombre}`, 'info', currentArea);
            } else {
                alert('Usuario o contraseÃ±a incorrectos');
            }
        });

        // MODIFICAR EL LOGOUT PARA LIMPIAR LA PERSISTENCIA
        logoutBtn.addEventListener('click', function() {
            cerrarSesionPersistente();
            currentUser = null;
            currentRole = null;
            currentArea = null;
            mainSystem.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginForm.reset();
            
            // Desconectar listeners de Firebase
            db.ref('ordenes').off();
            db.ref('notificaciones').off();
            db.ref('.info/connected').off();
        });

        // FUNCIÃ“N PARA INICIAR LISTENERS DE FIREBASE (reutilizable)
        function iniciarListenersFirebase() {
            // Escuchar cambios en tiempo real de Ã³rdenes
            db.ref('ordenes').on('value', (snapshot) => {
                ordenes = snapshot.val() || [];
                actualizarDashboard();
                actualizarTablaOrdenes();
            });
            
            // Escuchar cambios en tiempo real de notificaciones con clave
            db.ref('notificaciones').on('value', (snapshot) => {
                const notifsData = snapshot.val();
                if (notifsData) {
                    notificaciones = Object.entries(notifsData).map(([key, value]) => {
                        return { ...value, key: key };
                    });
                    
                    notificaciones.sort((a, b) => b.timestamp - a.timestamp);
                    actualizarNotificaciones();
                    
                    if (notificaciones.length > 0) {
                        const ultimaNotificacion = notificaciones[0];
                        if (ultimaNotificacion.destinatario === currentUser && 
                            ultimaNotificacion.timestamp > Date.now() - 10000) {
                            mostrarNotificacion(ultimaNotificacion.mensaje, ultimaNotificacion.tipo, ultimaNotificacion.area);
                        }
                    }
                } else {
                    notificaciones = [];
                    actualizarNotificaciones();
                }
            });
            
            // Monitorear estado de conexiÃ³n
            db.ref('.info/connected').on('value', (snapshot) => {
                const isConnected = snapshot.val();
                connectionStatus.classList.toggle('offline', !isConnected);
                connectionText.textContent = isConnected ? 'Conectado' : 'Desconectado';
            });
        }

        // VERIFICAR SI HAY SESIÃ“N AL CARGAR LA PÃGINA
        document.addEventListener('DOMContentLoaded', function() {
            if (!iniciarSesionAutomatica()) {
                // Si no hay sesiÃ³n activa, mostrar el login normalmente
                loginScreen.classList.remove('hidden');
            }
        });

        // El resto de las funciones del sistema se mantienen igual...
        // [Todas las demÃ¡s funciones permanecen sin cambios]

    </script>

    <style>
        /* ESTILOS MEJORADOS PARA EL LOGIN */
        .login-container {
            max-width: 450px;
            margin: 50px auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            z-index: 1;
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 2;
        }

        .login-logo {
            max-width: 150px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .login-header h2 {
            color: white;
            margin: 0;
            font-size: 1.3rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .login-form {
            position: relative;
            z-index: 2;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: white;
        }

        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
            box-sizing: border-box;
        }

        .password-group {
            position: relative;
        }

        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container input {
            padding-right: 50px;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .toggle-password:hover {
            background: rgba(0,0,0,0.1);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }

        .btn-login:hover {
            background: #ff5252;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 14px;
        }

        .remember-me input {
            width: auto;
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .login-container {
                margin: 20px;
                padding: 20px;
            }
            
            .login-header h2 {
                font-size: 1.1rem;
            }
        }

        /* Estilos existentes se mantienen... */
        .hidden {
            display: none !important;
        }
    </style>
</body>
</html>