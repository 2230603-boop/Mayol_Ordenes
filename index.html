<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Mayol Sistema De Ordenes</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <img src="./img/mayol.jpg" alt="Logo Mayol" class="login-logo">
            <h2>ùêíùê¢ùê¨ùê≠ùêûùê¶ùêö ùêÉùêû ùêéùê´ùêùùêûùêßùêûùê¨ ùêèùê´ùê®ùêùùêÆùêúùêúùê¢√≥ùêß ùê≤ ùêèùê´ùê®ùêúùêûùê¨ùê®</h2>
        </div>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group password-group">
                <label for="password">Contrase√±a:</label>
                <div class="password-input-container">
                    <input type="password" id="password" required>
                    <button type="button" class="toggle-password" id="togglePassword">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
            <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
            <div class="remember-me">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Recordar mi sesi√≥n</label>
            </div>
        </form>
    </div>

    <!-- Sistema Principal (oculto inicialmente) -->
    <div id="mainSystem" class="container hidden">
        <div class="header">
            <div class="logo">ùôÄùôàùòΩùôäùôèùôÄùôáùôáùòºùòøùôäùôçùòº ùôàùòºùôîùôäùôá ùôé.ùòº. ùòøùôÄ ùòæ.ùôë</div>
            <div class="user-info">
                <span id="currentUser">Usuario</span>
                <span class="user-role" id="currentRole">Rol</span>
                <div class="connection-status">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">Conectado</span>
                </div>
                <button id="logoutBtn" class="btn btn-secondary">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">Dashboard</div>
            <div class="nav-tab" data-tab="nueva-orden" id="tabNuevaOrden">Nueva Orden</div>
            <div class="nav-tab" data-tab="ordenes" id="tabOrdenes">√ìrdenes</div>
            <div class="nav-tab" data-tab="notificaciones" id="tabNotificaciones">Notificaciones</div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard" id="dashboardContent">
                <!-- Contenido del dashboard se carga din√°micamente seg√∫n el usuario -->
            </div>
        </div>

        <!-- Nueva Orden -->
        <div id="nueva-orden" class="tab-content">
            <div class="form-container">
                <!-- Contenido del formulario se carga din√°micamente seg√∫n el usuario -->
            </div>
        </div>

        <!-- √ìrdenes -->
        <div id="ordenes" class="tab-content">
            <div class="dashboard" id="ordenesContent">
                <!-- Contenido de √≥rdenes se carga din√°micamente seg√∫n el usuario -->
            </div>
        </div>

        <!-- Notificaciones -->
        <div id="notificaciones" class="tab-content">
            <div class="dashboard" id="notificacionesContent">
                <!-- Contenido de notificaciones se carga din√°micamente seg√∫n el usuario -->
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n y Comunicaci√≥n -->
    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gesti√≥n de Orden de Trabajo</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-container">
                <div class="form-section">
                    <h4>Informaci√≥n de la Orden</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editarSolicitante">SOLICITANTE</label>
                            <input type="text" id="editarSolicitante" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editarResponsable">RESPONSABLE</label>
                            <select id="editarResponsable">
                                <option value="Benito Suarez">BENITO SUAREZ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editarMaquina">M√ÅQUINA/EQUIPO</label>
                            <input type="text" id="editarMaquina" required>
                        </div>
                        <div class="form-group">
                            <label for="editarPrioridad">PRIORIDAD</label>
                            <select id="editarPrioridad" required>
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <label for="editarDescripcion">DESCRIPCI√ìN DEL PROBLEMA</label>
                    <textarea id="editarDescripcion" required></textarea>
                </div>

                <!-- Secci√≥n de Comunicaci√≥n Jefe-Responsable -->
                <div class="form-section" id="seccionComunicacion">
                    <h4>Comunicaci√≥n y Actualizaciones</h4>
                    <div class="form-group">
                        <label for="comunicacionJefe">INSTRUCCIONES/ACTUALIZACIONES DEL JEFE:</label>
                        <textarea id="comunicacionJefe" placeholder="Ej: Los repuestos ya est√°n disponibles en almac√©n, puedes proceder con la reparaci√≥n..."></textarea>
                    </div>
                    <button class="btn btn-warning" id="btnEnviarComunicacion">Enviar Actualizaci√≥n al Responsable</button>
                </div>

                <!-- Historial de la Orden -->
                <div class="form-section">
                    <h4>Historial de la Orden</h4>
                    <div class="timeline" id="timelineOrden">
                        <div class="empty-message">No hay historial disponible</div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" id="btnCancelarEdicion">Cerrar</button>
                    <button class="btn btn-primary" id="btnGuardarEdicion">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n flotante -->
    <div id="notification" class="notification">
        <span id="notificationText">Nueva orden asignada</span>
    </div>

    <script>
        // CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB1ywwzR49KiEZC16_rhh9pmw0aMfT8Zxo",
            authDomain: "sistema-de-ordenes-de-trabajo.firebaseapp.com",
            databaseURL: "https://sistema-de-ordenes-de-trabajo-default-rtdb.firebaseio.com",
            projectId: "sistema-de-ordenes-de-trabajo",
            storageBucket: "sistema-de-ordenes-de-trabajo.firebasestorage.app",
            messagingSenderId: "328684805267",
            appId: "1:328684805267:web:ebbd2d1957ad7275ea4166",
            measurementId: "G-SGVGP74MBL"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // üîÑ CONTADORES SEPARADOS PARA PRODUCCI√ìN Y PROCESO
        let contadorProduccion = 1;
        let contadorProceso = 1;

        // Funci√≥n para cargar contadores desde Firebase
        function cargarContadores() {
            db.ref('contadorProduccion').once('value').then((snapshot) => {
                contadorProduccion = snapshot.val() || 1;
            });
            
            db.ref('contadorProceso').once('value').then((snapshot) => {
                contadorProceso = snapshot.val() || 1;
            });
        }

        // Variables globales
        let ordenes = [];
        let notificaciones = [];
        let currentUser = null;
        let currentRole = null;
        let currentArea = null;
        let ordenEditando = null;

        // Elementos del DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const loginForm = document.getElementById('loginForm');
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const rememberMe = document.getElementById('rememberMe');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const currentRoleSpan = document.getElementById('currentRole');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        
        // Elementos del modal de edici√≥n
        const modalEditar = document.getElementById('modalEditar');
        const closeModal = document.querySelector('.close-modal');
        const btnCancelarEdicion = document.getElementById('btnCancelarEdicion');
        const btnGuardarEdicion = document.getElementById('btnGuardarEdicion');
        const btnEnviarComunicacion = document.getElementById('btnEnviarComunicacion');
        const comunicacionJefe = document.getElementById('comunicacionJefe');
        const timelineOrden = document.getElementById('timelineOrden');

        // Sistema de autenticaci√≥n con usuarios espec√≠ficos y permisos unificados
        const usuarios = {
            'RODRIGO': { 
                password: 'produccion_0', 
                role: 'jefe', 
                nombre: 'RODRIGO SAMPERIO', 
                area: 'produccion',
                permisos: ['crear_orden', 'editar_orden', 'gestionar_orden', 'ver_dashboard', 'ver_ordenes', 'ver_notificaciones']
            },
            'EDGAR': { 
                password: 'proceso_0', 
                role: 'jefe', 
                nombre: 'EDGAR', 
                area: 'proceso',
                permisos: ['crear_orden', 'editar_orden', 'gestionar_orden', 'ver_dashboard', 'ver_ordenes', 'ver_notificaciones']
            },
            'BENITO': { 
                password: 'mantenimiento_01', 
                role: 'responsable', 
                nombre: 'BENITO SUAREZ', 
                area: null,
                permisos: ['ver_dashboard', 'ver_ordenes', 'ver_notificaciones', 'cambiar_estado']
            }
        };

        // FUNCI√ìN PARA VER CONTRASE√ëA
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
        });

        // FUNCIONES DE PERSISTENCIA DE SESI√ìN
        function guardarSesion(usuario, recordar) {
            if (recordar) {
                localStorage.setItem('sistemaMayol_usuario', usuario);
                localStorage.setItem('sistemaMayol_sesion', 'activa');
            } else {
                sessionStorage.setItem('sistemaMayol_usuario', usuario);
                sessionStorage.setItem('sistemaMayol_sesion', 'activa');
            }
        }

        function verificarSesionActiva() {
            const usuarioLocal = localStorage.getItem('sistemaMayol_usuario');
            const usuarioSession = sessionStorage.getItem('sistemaMayol_usuario');
            
            return usuarioLocal || usuarioSession;
        }

        function obtenerUsuarioGuardado() {
            return localStorage.getItem('sistemaMayol_usuario') || sessionStorage.getItem('sistemaMayol_usuario');
        }

        function cerrarSesionPersistente() {
            localStorage.removeItem('sistemaMayol_usuario');
            localStorage.removeItem('sistemaMayol_sesion');
            sessionStorage.removeItem('sistemaMayol_usuario');
            sessionStorage.removeItem('sistemaMayol_sesion');
        }

        // FUNCI√ìN PARA INICIAR SESI√ìN AUTOM√ÅTICAMENTE SI HAY SESI√ìN GUARDADA
        function iniciarSesionAutomatica() {
            const usuarioGuardado = obtenerUsuarioGuardado();
            if (usuarioGuardado && usuarios[usuarioGuardado]) {
                // Simular inicio de sesi√≥n autom√°tico
                currentUser = usuarioGuardado;
                currentRole = usuarios[usuarioGuardado].role;
                currentArea = usuarios[usuarioGuardado].area;
                
                // Actualizar interfaz
                document.getElementById('currentUser').textContent = usuarios[usuarioGuardado].nombre;
                document.getElementById('currentRole').textContent = currentRole === 'jefe' ? 
                    (currentArea === 'proceso' ? 'Jefe Proceso' : 'Jefe Producci√≥n') : 
                    'Responsable';
                
                if (currentArea === 'proceso') {
                    document.getElementById('currentRole').classList.add('proceso');
                }
                
                cargarContadores();
                
                // Configurar interfaz seg√∫n el rol
                if (currentRole === 'responsable') {
                    document.getElementById('tabNuevaOrden').classList.add('hidden');
                } else {
                    document.getElementById('tabNuevaOrden').classList.remove('hidden');
                    cargarFormularioNuevaOrden();
                }
                
                loginScreen.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                
                // Escuchar cambios en tiempo real
                iniciarListenersFirebase();
                
                mostrarNotificacion(`Bienvenido de nuevo ${usuarios[usuarioGuardado].nombre}`, 'info', currentArea);
                return true;
            }
            return false;
        }

        //Funci√≥n mejorada para verificar credenciales
        function verificarCredenciales(username, password) {
            // Normalizar el nombre de usuario (eliminar espacios y convertir a may√∫sculas)
            const usuarioNormalizado = username.trim().toUpperCase();
            
            // Verificar si el usuario existe
            if (!usuarios[usuarioNormalizado]) {
                return false;
            }
            
            // Verificar la contrase√±a
            if (usuarios[usuarioNormalizado].password !== password) {
                return false;
            }
            
            return true;
        }

        // Funci√≥n para verificar permisos
        function tienePermiso(permiso) {
            return usuarios[currentUser]?.permisos?.includes(permiso) || false;
        }

        // Funci√≥n para formatear fecha como DD/MM/YYYY
        function obtenerFechaActual() {
            const ahora = new Date();
            const dia = String(ahora.getDate()).padStart(2, '0');
            const mes = String(ahora.getMonth() + 1).padStart(2, '0');
            const a√±o = ahora.getFullYear();
            return { dia, mes, a√±o };
        }

        // Funci√≥n para obtener fecha y hora actual en formato legible
        function obtenerFechaHoraActual() {
            const ahora = new Date();
            return ahora.toLocaleString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        //Generar n√∫mero de orden con contadores independientes
        function generarNumeroOrden(area) {
            const fecha = obtenerFechaActual();
            const prefijo = area === 'proceso' ? 'OTP' : 'OT';
            
            // Usar el contador correspondiente al √°rea
            let contador;
            if (area === 'proceso') {
                contador = contadorProceso;
                contadorProceso++;
                // Guardar en Firebase
                db.ref('contadorProceso').set(contadorProceso);
            } else {
                contador = contadorProduccion;
                contadorProduccion++;
                // Guardar en Firebase
                db.ref('contadorProduccion').set(contadorProduccion);
            }
            
            return `${prefijo}/${fecha.dia}/${fecha.mes}/${fecha.a√±o}/${contador}`;
        }

        // Funci√≥n para mostrar notificaci√≥n
        function mostrarNotificacion(mensaje, tipo = 'info', area = null) {
            notificationText.textContent = mensaje;
            notification.className = 'notification';
            notification.classList.add(tipo);
            if (area) {
                notification.classList.add(area);
            }
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        //CORRECCI√ìN 2: Funci√≥n mejorada para actualizar notificaciones con pesta√±as separadas
        function actualizarNotificaciones() {
            const notificacionesContent = document.getElementById('notificacionesContent');
            
            // Filtrar notificaciones solo para el usuario actual
            const notificacionesUsuario = notificaciones.filter(notif => 
                notif.destinatario === currentUser || notif.destinatario === usuarios[currentUser]?.nombre
            );
            
            if (currentRole === 'responsable') {
                // Para el responsable: mostrar pesta√±as separadas (producci√≥n y proceso)
                let notificacionesProduccion = notificacionesUsuario.filter(notif => 
                    notif.area === 'produccion' || notif.area === undefined
                );
                
                let notificacionesProceso = notificacionesUsuario.filter(notif => 
                    notif.area === 'proceso'
                );
                
                let notificacionesHTML = `
                    <h2>Notificaciones</h2>
                    <div class="notifications-tabs">
                        <div class="notification-tab active" data-notification-tab="produccion">Notificaciones de Producci√≥n</div>
                        <div class="notification-tab proceso" data-notification-tab="proceso">Notificaciones de Proceso</div>
                    </div>
                    
                    <div class="notification-content active" id="notification-produccion">
                        <h3>Producci√≥n</h3>
                `;
                
                if (notificacionesProduccion.length === 0) {
                    notificacionesHTML += '<div class="empty-message">No hay notificaciones de producci√≥n</div>';
                } else {
                    notificacionesProduccion.forEach((notif, index) => {
                        notificacionesHTML += `
                            <div class="notification-item">
                                <h4>${notif.titulo}</h4>
                                <p>${notif.mensaje}</p>
                                ${notif.detalles ? `<div class="order-details">
                                    <h4>Detalles:</h4>
                                    <p><strong>M√°quina:</strong> ${notif.detalles.maquina}</p>
                                    <p><strong>Descripci√≥n:</strong> ${notif.detalles.descripcion}</p>
                                    <p><strong>Prioridad:</strong> ${notif.detalles.prioridad}</p>
                                    <p><strong>Fecha Prometida:</strong> ${notif.detalles.fechaPrometida}</p>
                                    <p><strong>Tipo de Mantenimiento:</strong> ${notif.detalles.tipoMantenimiento}</p>
                                    <p><strong>L√≠neas:</strong> ${notif.detalles.lineas}</p>
                                    ${notif.detalles.observaciones ? `<p><strong>Observaciones:</strong> ${notif.detalles.observaciones}</p>` : ''}
                                </div>` : ''}
                                <small>${new Date(notif.timestamp).toLocaleString()}</small>
                                <button class="btn-delete-notification" onclick="eliminarNotificacion('${notif.key}')">Eliminar</button>
                            </div>
                        `;
                    });
                }
                
                notificacionesHTML += `
                    </div>
                    
                    <div class="notification-content" id="notification-proceso">
                        <h3 class="proceso">Proceso</h3>
                `;
                
                if (notificacionesProceso.length === 0) {
                    notificacionesHTML += '<div class="empty-message">No hay notificaciones de proceso</div>';
                } else {
                    notificacionesProceso.forEach((notif, index) => {
                        notificacionesHTML += `
                            <div class="notification-item proceso">
                                <h4>${notif.titulo}</h4>
                                <p>${notif.mensaje}</p>
                                ${notif.detalles ? `<div class="order-details proceso">
                                    <h4>Detalles:</h4>
                                    <p><strong>M√°quina:</strong> ${notif.detalles.maquina}</p>
                                    <p><strong>Descripci√≥n:</strong> ${notif.detalles.descripcion}</p>
                                    <p><strong>Prioridad:</strong> ${notif.detalles.prioridad}</p>
                                    <p><strong>Fecha Prometida:</strong> ${notif.detalles.fechaPrometida}</p>
                                    <p><strong>Tipo de Mantenimiento:</strong> ${notif.detalles.tipoMantenimiento}</p>
                                    <p><strong>L√≠neas:</strong> ${notif.detalles.lineas}</p>
                                    ${notif.detalles.observaciones ? `<p><strong>Observaciones:</strong> ${notif.detalles.observaciones}</p>` : ''}
                                </div>` : ''}
                                <small>${new Date(notif.timestamp).toLocaleString()}</small>
                                <button class="btn-delete-notification" onclick="eliminarNotificacion('${notif.key}')">Eliminar</button>
                            </div>
                        `;
                    });
                }
                
                notificacionesHTML += `
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-danger" id="btnLimpiarNotificaciones">Limpiar Mis Notificaciones</button>
                    </div>
                `;
                
                notificacionesContent.innerHTML = notificacionesHTML;
                
                // Agregar event listeners a las pesta√±as de notificaciones
                document.querySelectorAll('.notification-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-notification-tab');
                        
                        document.querySelectorAll('.notification-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        this.classList.add('active');
                        
                        document.querySelectorAll('.notification-content').forEach(content => {
                            content.classList.remove('active');
                            if (content.id === 'notification-' + tabId) {
                                content.classList.add('active');
                            }
                        });
                    });
                });
                
                // Agregar event listener al bot√≥n de limpiar notificaciones
                document.getElementById('btnLimpiarNotificaciones').addEventListener('click', limpiarTodasLasNotificaciones);
            } else {
                // Para los jefes: mostrar notificaciones normales
                if (notificacionesUsuario.length === 0) {
                    notificacionesContent.innerHTML = '<h2>Notificaciones</h2><div class="empty-message">No hay notificaciones</div>';
                } else {
                    let notificacionesHTML = '<h2>Notificaciones</h2>';
                    notificacionesUsuario.forEach((notif, index) => {
                        notificacionesHTML += `
                            <div class="notification-item ${notif.area === 'proceso' ? 'proceso' : ''}">
                                <h4>${notif.titulo}</h4>
                                <p>${notif.mensaje}</p>
                                ${notif.detalles ? `<div class="order-details ${notif.area === 'proceso' ? 'proceso' : ''}">
                                    <h4>Detalles:</h4>
                                    <p><strong>M√°quina:</strong> ${notif.detalles.maquina}</p>
                                    <p><strong>Descripcion:</strong> ${notif.detalles.descripcion}</p>
                                    <p><strong>Prioridad:</strong> ${notif.detalles.prioridad}</p>
                                    <p><strong>Fecha Prometida:</strong> ${notif.detalles.fechaPrometida}</p>
                                    <p><strong>Tipo de Mantenimiento:</strong> ${notif.detalles.tipoMantenimiento}</p>
                                    <p><strong>L√≠neas:</strong> ${notif.detalles.lineas}</p>
                                    ${notif.detalles.observaciones ? `<p><strong>Observaciones:</strong> ${notif.detalles.observaciones}</p>` : ''}
                                </div>` : ''}
                                <small>${new Date(notif.timestamp).toLocaleString()}</small>
                                <button class="btn-delete-notification" onclick="eliminarNotificacion('${notif.key}')">Eliminar</button>
                            </div>
                        `;
                    });
                    notificacionesContent.innerHTML = notificacionesHTML;
                }
            }
        }

        // Funci√≥n para actualizar el timeline/historial de una orden
        function actualizarTimeline(orden) {
            if (!orden.historial) {
                timelineOrden.innerHTML = '<div class="empty-message">No hay historial disponible</div>';
                return;
            }

            let timelineHTML = '';
            orden.historial.forEach(evento => {
                timelineHTML += `
                    <div class="timeline-item">
                        <span class="timeline-time">${evento.fecha}</span>
                        <span class="timeline-event">${evento.descripcion}</span>
                        ${evento.detalles ? `<br><small>${evento.detalles}</small>` : ''}
                    </div>
                `;
            });

            // Agregar comunicaci√≥n del jefe si existe
            if (orden.comunicacionJefe && orden.comunicacionJefe.length > 0) {
                orden.comunicacionJefe.forEach(comunicacion => {
                    timelineHTML += `
                        <div class="timeline-item">
                            <span class="timeline-time">${comunicacion.fecha}</span>
                            <div class="comunicacion-jefe ${orden.area === 'proceso' ? 'proceso' : ''}">
                                <strong>Actualizaci√≥n del Jefe:</strong>
                                <p>${comunicacion.mensaje}</p>
                            </div>
                        </div>
                    `;
                });
            }

            timelineOrden.innerHTML = timelineHTML;
        }

        // Funci√≥n para abrir modal de edici√≥n
        function abrirModalEdicion(ordenId) {
            const orden = ordenes.find(o => o.id === ordenId);
            if (!orden) return;

            ordenEditando = orden;

            // Aplicar estilos seg√∫n el √°rea
            const modalHeader = modalEditar.querySelector('.modal-header');
            const btnGuardar = document.getElementById('btnGuardarEdicion');
            
            if (orden.area === 'proceso') {
                modalHeader.classList.add('proceso');
                btnGuardar.classList.add('proceso');
            } else {
                modalHeader.classList.remove('proceso');
                btnGuardar.classList.remove('proceso');
            }

            // Llenar el formulario con los datos actuales
            document.getElementById('editarSolicitante').value = orden.solicitante || '';
            document.getElementById('editarResponsable').value = orden.responsable || '';
            document.getElementById('editarMaquina').value = orden.maquina || '';
            document.getElementById('editarPrioridad').value = orden.prioridad || 'baja';
            document.getElementById('editarDescripcion').value = orden.descripcion || '';
            
            // Limpiar campo de comunicaci√≥n
            comunicacionJefe.value = '';

            // Actualizar timeline
            actualizarTimeline(orden);

            // Mostrar/ocultar secci√≥n de comunicaci√≥n seg√∫n el rol
            const seccionComunicacion = document.getElementById('seccionComunicacion');
            if (currentRole === 'jefe') {
                seccionComunicacion.style.display = 'block';
            } else {
                seccionComunicacion.style.display = 'none';
            }

            // Mostrar modal
            modalEditar.style.display = 'block';
        }

        // Funci√≥n para cerrar modal de edici√≥n
        function cerrarModalEdicion() {
            modalEditar.style.display = 'none';
            ordenEditando = null;
        }

        // MEJORA 1: Funci√≥n para enviar comunicaci√≥n del jefe al responsable y reabrir la orden
        function enviarComunicacionJefe() {
            if (!ordenEditando || !comunicacionJefe.value.trim()) {
                alert('Por favor, escriba un mensaje para el responsable');
                return;
            }

            const ordenIndex = ordenes.findIndex(o => o.id === ordenEditando.id);
            if (ordenIndex !== -1) {
                const comunicacion = {
                    mensaje: comunicacionJefe.value.trim(),
                    fecha: obtenerFechaHoraActual(),
                    enviadoPor: currentUser
                };

                // Agregar comunicaci√≥n al historial
                if (!ordenes[ordenIndex].comunicacionJefe) {
                    ordenes[ordenIndex].comunicacionJefe = [];
                }
                ordenes[ordenIndex].comunicacionJefe.push(comunicacion);

                // MEJORA 1: Si la orden estaba completada o cancelada, reactivarla
                if (ordenes[ordenIndex].estado === 'completado' || ordenes[ordenIndex].estado === 'cancelado') {
                    ordenes[ordenIndex].estado = 'pendiente';
                    ordenes[ordenIndex].fechaReactivacion = obtenerFechaHoraActual();
                    
                    // Agregar evento al historial
                    if (!ordenes[ordenIndex].historial) {
                        ordenes[ordenIndex].historial = [];
                    }
                    ordenes[ordenIndex].historial.push({
                        fecha: obtenerFechaHoraActual(),
                        descripcion: 'Orden reactivada por el jefe',
                        detalles: `Motivo: ${comunicacionJefe.value.trim()}`
                    });
                }

                // Guardar en Firebase
                db.ref('ordenes').set(ordenes);

                // Crear notificaci√≥n para el responsable
                crearNotificacion(
                    'Actualizaci√≥n en orden de trabajo',
                    `El jefe ha actualizado la orden ${ordenEditando.id}: ${comunicacionJefe.value.substring(0, 100)}...`,
                    'urgente',
                    'BENITO', // Destinatario espec√≠fico
                    ordenes[ordenIndex].area
                );

                mostrarNotificacion('Comunicaci√≥n enviada al responsable y orden reabierta', 'info', ordenes[ordenIndex].area);
                comunicacionJefe.value = '';
                actualizarTimeline(ordenes[ordenIndex]);
                actualizarDashboard();
                actualizarTablaOrdenes();
            }
        }

        // Funci√≥n para guardar cambios de edici√≥n
        function guardarCambiosEdicion() {
            if (!ordenEditando) return;

            const solicitante = document.getElementById('editarSolicitante').value;
            const responsable = document.getElementById('editarResponsable').value;
            const maquina = document.getElementById('editarMaquina').value;
            const prioridad = document.getElementById('editarPrioridad').value;
            const descripcion = document.getElementById('editarDescripcion').value;

            if (!maquina || !descripcion) {
                alert('Por favor, complete todos los campos obligatorios');
                return;
            }

            // Actualizar la orden
            const ordenIndex = ordenes.findIndex(o => o.id === ordenEditando.id);
            if (ordenIndex !== -1) {
                ordenes[ordenIndex] = {
                    ...ordenes[ordenIndex],
                    solicitante,
                    responsable,
                    maquina,
                    prioridad,
                    descripcion
                };

                // Guardar en Firebase
                db.ref('ordenes').set(ordenes);

                mostrarNotificacion(`Orden ${ordenEditando.id} actualizada correctamente`, 'info', ordenes[ordenIndex].area);
                cerrarModalEdicion();
            }
        }

        // Funci√≥n para actualizar el dashboard seg√∫n el usuario
        function actualizarDashboard() {
            const dashboardContent = document.getElementById('dashboardContent');
            
            if (currentRole === 'responsable') {
                // Para el responsable: mostrar estad√≠sticas de ambas √°reas
                let ordenesFiltradas = ordenes;
                
                const totalProgramadas = ordenesFiltradas.length;
                const pendientes = ordenesFiltradas.filter(o => o.estado === 'pendiente').length;
                const enProceso = ordenesFiltradas.filter(o => o.estado === 'proceso').length;
                const completadas = ordenesFiltradas.filter(o => o.estado === 'completado').length;
                const noRealizadas = ordenesFiltradas.filter(o => o.estado === 'cancelado').length;
                
                // Estad√≠sticas por √°rea
                const ordenesProduccion = ordenesFiltradas.filter(o => o.area === 'produccion' || o.area === undefined);
                const ordenesProceso = ordenesFiltradas.filter(o => o.area === 'proceso');
                
                const pendientesProduccion = ordenesProduccion.filter(o => o.estado === 'pendiente').length;
                const enProcesoProduccion = ordenesProduccion.filter(o => o.estado === 'proceso').length;
                const completadasProduccion = ordenesProduccion.filter(o => o.estado === 'completado').length;
                
                const pendientesProceso = ordenesProceso.filter(o => o.estado === 'pendiente').length;
                const enProcesoProceso = ordenesProceso.filter(o => o.estado === 'proceso').length;
                const completadasProceso = ordenesProceso.filter(o => o.estado === 'completado').length;
                
                dashboardContent.innerHTML = `
                    <h2>Dashboard de √ìrdenes de Trabajo</h2>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div>Total Programadas</div>
                            <div class="stat-number" id="totalProgramadas">${totalProgramadas}</div>
                        </div>
                        <div class="stat-card">
                            <div>Pendientes</div>
                            <div class="stat-number" id="pendientes">${pendientes}</div>
                        </div>
                        <div class="stat-card">
                            <div>En Proceso</div>
                            <div class="stat-number" id="enProceso">${enProceso}</div>
                        </div>
                        <div class="stat-card">
                            <div>Completadas</div>
                            <div class="stat-number" id="completadas">${completadas}</div>
                        </div>
                        <div class="stat-card">
                            <div>No Realizadas</div>
                            <div class="stat-number" id="noRealizadas">${noRealizadas}</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
                        <div>
                            <h3>Producci√≥n</h3>
                            <div class="stats-container">
                                <div class="stat-card">
                                    <div>Pendientes</div>
                                    <div class="stat-number">${pendientesProduccion}</div>
                                </div>
                                <div class="stat-card">
                                    <div>En Proceso</div>
                                    <div class="stat-number">${enProcesoProduccion}</div>
                                </div>
                                <div class="stat-card">
                                    <div>Completadas</div>
                                    <div class="stat-number">${completadasProduccion}</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="proceso">Proceso</h3>
                            <div class="stats-container">
                                <div class="stat-card proceso">
                                    <div>Pendientes</div>
                                    <div class="stat-number">${pendientesProceso}</div>
                                </div>
                                <div class="stat-card proceso">
                                    <div>En Proceso</div>
                                    <div class="stat-number">${enProcesoProceso}</div>
                                </div>
                                <div class="stat-card proceso">
                                    <div>Completadas</div>
                                    <div class="stat-number">${completadasProceso}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 20px;">√ìrdenes No Realizadas</h3>
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>No. Orden</th>
                                <th>√Årea</th>
                                <th>M√°quina/Equipo</th>
                                <th>Fecha Programada</th>
                                <th>Descripci√≥n del Problema</th>
                                <th>Motivo de No Realizaci√≥n</th>
                                <th>Fecha/Hora Cancelaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaNoRealizadas">
                            ${ordenesFiltradas.filter(o => o.estado === 'cancelado').length === 0 ? 
                                '<tr><td colspan="7" class="empty-message">No hay √≥rdenes no realizadas</td></tr>' : 
                                ordenesFiltradas.filter(o => o.estado === 'cancelado').map(orden => `
                                    <tr>
                                        <td>${orden.id}</td>
                                        <td>${orden.area === 'proceso' ? 'Proceso' : 'Producci√≥n'}</td>
                                        <td>${orden.maquina}</td>
                                        <td>${orden.fechaPrometida}</td>
                                        <td>${orden.descripcion}</td>
                                        <td>${orden.motivoCancelacion || 'Sin motivo especificado'}</td>
                                        <td>${orden.fechaCancelacion || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                // Para los jefes: mostrar solo las √≥rdenes de su √°rea
                let ordenesFiltradas = ordenes.filter(o => o.area === currentArea);
                
                const totalProgramadas = ordenesFiltradas.length;
                const pendientes = ordenesFiltradas.filter(o => o.estado === 'pendiente').length;
                const enProceso = ordenesFiltradas.filter(o => o.estado === 'proceso').length;
                const completadas = ordenesFiltradas.filter(o => o.estado === 'completado').length;
                const noRealizadas = ordenesFiltradas.filter(o => o.estado === 'cancelado').length;
                
                dashboardContent.innerHTML = `
                    <h2 class="${currentArea === 'proceso' ? 'proceso' : ''}">Dashboard de √ìrdenes de Trabajo - ${currentArea === 'proceso' ? 'Proceso' : 'Producci√≥n'}</h2>
                    
                    <div class="stats-container">
                        <div class="stat-card ${currentArea === 'proceso' ? 'proceso' : ''}">
                            <div>Total Programadas</div>
                            <div class="stat-number" id="totalProgramadas">${totalProgramadas}</div>
                        </div>
                        <div class="stat-card ${currentArea === 'proceso' ? 'proceso' : ''}">
                            <div>Pendientes</div>
                            <div class="stat-number" id="pendientes">${pendientes}</div>
                        </div>
                        <div class="stat-card ${currentArea === 'proceso' ? 'proceso' : ''}">
                            <div>En Proceso</div>
                            <div class="stat-number" id="enProceso">${enProceso}</div>
                        </div>
                        <div class="stat-card ${currentArea === 'proceso' ? 'proceso' : ''}">
                            <div>Completadas</div>
                            <div class="stat-number" id="completadas">${completadas}</div>
                        </div>
                        <div class="stat-card ${currentArea === 'proceso' ? 'proceso' : ''}">
                            <div>No Realizadas</div>
                            <div class="stat-number" id="noRealizadas">${noRealizadas}</div>
                        </div>
                    </div>
                    
                    <h3>√ìrdenes No Realizadas</h3>
                    <table class="orders-table ${currentArea === 'proceso' ? 'proceso' : ''}">
                        <thead>
                            <tr>
                                <th>No. Orden</th>
                                <th>M√°quina/Equipo</th>
                                <th>Fecha Programada</th>
                                <th>Descripci√≥n del Problema</th>
                                <th>Motivo de No Realizaci√≥n</th>
                                <th>Fecha/Hora Cancelaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaNoRealizadas">
                            ${ordenesFiltradas.filter(o => o.estado === 'cancelado').length === 0 ? 
                                '<tr><td colspan="6" class="empty-message">No hay √≥rdenes no realizadas</td></tr>' : 
                                ordenesFiltradas.filter(o => o.estado === 'cancelado').map(orden => `
                                    <tr>
                                        <td>${orden.id}</td>
                                        <td>${orden.maquina}</td>
                                        <td>${orden.fechaPrometida}</td>
                                        <td>${orden.descripcion}</td>
                                        <td>${orden.motivoCancelacion || 'Sin motivo especificado'}</td>
                                        <td>${orden.fechaCancelacion || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // Funci√≥n para actualizar la tabla de √≥rdenes seg√∫n el usuario
        function actualizarTablaOrdenes() {
            const ordenesContent = document.getElementById('ordenesContent');
            
            if (currentRole === 'responsable') {
                // Para el responsable: mostrar dos tablas (producci√≥n y proceso)
                let ordenesProduccion = ordenes.filter(o => o.area === 'produccion' || o.area === undefined);
                let ordenesProceso = ordenes.filter(o => o.area === 'proceso');
                
                // Ordenar por timestamp descendente (m√°s recientes primero)
                ordenesProduccion.sort((a, b) => b.timestamp - a.timestamp);
                ordenesProceso.sort((a, b) => b.timestamp - a.timestamp);
                
                ordenesContent.innerHTML = `
                    <h2>√ìrdenes de Trabajo</h2>
                    <div class="orders-container">
                        <div class="order-section">
                            <h3>Producci√≥n</h3>
                            <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th>No. Orden</th>
                                        <th>M√°quina/Equipo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Prioridad</th>
                                        <th>Fecha Prometida</th>
                                        <th>Estado</th>
                                        <th>√öltima Actualizaci√≥n</th>
                                        <th>Completada/Cancelada</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordenesProduccion.length === 0 ? 
                                        '<tr><td colspan="9" class="empty-message">No hay √≥rdenes de producci√≥n</td></tr>' : 
                                        ordenesProduccion.map(orden => {
                                            const estadoClass = `status-${orden.estado}`;
                                            const prioridadClass = `status-${orden.prioridad}`;
                                            
                                            let ultimaActualizacion = 'N/A';
                                            if (orden.fechaCompletado) {
                                                ultimaActualizacion = `Completada: ${orden.fechaCompletado}`;
                                            } else if (orden.fechaCancelacion) {
                                                ultimaActualizacion = `Cancelada: ${orden.fechaCancelacion}`;
                                            } else if (orden.fechaProceso) {
                                                ultimaActualizacion = `En proceso: ${orden.fechaProceso}`;
                                            } else if (orden.fechaPendiente) {
                                                ultimaActualizacion = `Pendiente: ${orden.fechaPendiente}`;
                                            }

                                            let fechaFinal = 'N/A';
                                            if (orden.fechaCompletado) {
                                                fechaFinal = orden.fechaCompletado;
                                            } else if (orden.fechaCancelacion) {
                                                fechaFinal = orden.fechaCancelacion;
                                            }

                                            return `
                                                <tr>
                                                    <td>${orden.id}</td>
                                                    <td>${orden.maquina}</td>
                                                    <td class="descripcion-completa">${orden.descripcion}</td>
                                                    <td><span class="status-badge ${prioridadClass}">${orden.prioridad}</span></td>
                                                    <td>${orden.fechaPrometida}</td>
                                                    <td><span class="status-badge ${estadoClass}">${orden.estado}</span></td>
                                                    <td>${ultimaActualizacion}</td>
                                                    <td>${fechaFinal}</td>
                                                    <td>
                                                        ${orden.estado !== 'completado' && orden.estado !== 'cancelado' ? 
                                                            `<button class="action-btn btn-pendiente" onclick="marcarComoPendiente('${orden.id}')">Pendiente</button>
                                                             <button class="action-btn btn-proceso" onclick="cambiarEstado('${orden.id}', 'proceso')">En Proceso</button>
                                                             <button class="action-btn btn-complete" onclick="cambiarEstado('${orden.id}', 'completado')">Completar</button>
                                                             <button class="action-btn btn-cancel" onclick="cancelarOrden('${orden.id}')">Cancelar</button>` : ''}
                                                        ${orden.estado === 'cancelado' && orden.comunicacionJefe && orden.comunicacionJefe.length > 0 ? 
                                                            `<button class="action-btn btn-reactivar" onclick="reactivarOrden('${orden.id}')">Reactivar</button>` : ''}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="order-section">
                            <h3 class="proceso">Proceso</h3>
                            <table class="orders-table proceso">
                                <thead>
                                    <tr>
                                        <th>No. Orden</th>
                                        <th>M√°quina/Equipo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Prioridad</th>
                                        <th>Fecha Prometida</th>
                                        <th>Estado</th>
                                        <th>√öltima Actualizaci√≥n</th>
                                        <th>Completada/Cancelada</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordenesProceso.length === 0 ? 
                                        '<tr><td colspan="9" class="empty-message">No hay √≥rdenes de proceso</td></tr>' : 
                                        ordenesProceso.map(orden => {
                                            const estadoClass = `status-${orden.estado}`;
                                            const prioridadClass = `status-${orden.prioridad}`;
                                            
                                            let ultimaActualizacion = 'N/A';
                                            if (orden.fechaCompletado) {
                                                ultimaActualizacion = `Completada: ${orden.fechaCompletado}`;
                                            } else if (orden.fechaCancelacion) {
                                                ultimaActualizacion = `Cancelada: ${orden.fechaCancelacion}`;
                                            } else if (orden.fechaProceso) {
                                                ultimaActualizacion = `En proceso: ${orden.fechaProceso}`;
                                            } else if (orden.fechaPendiente) {
                                                ultimaActualizacion = `Pendiente: ${orden.fechaPendiente}`;
                                            }

                                            let fechaFinal = 'N/A';
                                            if (orden.fechaCompletado) {
                                                fechaFinal = orden.fechaCompletado;
                                            } else if (orden.fechaCancelacion) {
                                                fechaFinal = orden.fechaCancelacion;
                                            }

                                            return `
                                                <tr>
                                                    <td>${orden.id}</td>
                                                    <td>${orden.maquina}</td>
                                                    <td class="descripcion-completa">${orden.descripcion}</td>
                                                    <td><span class="status-badge ${prioridadClass}">${orden.prioridad}</span></td>
                                                    <td>${orden.fechaPrometida}</td>
                                                    <td><span class="status-badge ${estadoClass}">${orden.estado}</span></td>
                                                    <td>${ultimaActualizacion}</td>
                                                    <td>${fechaFinal}</td>
                                                    <td>
                                                        ${orden.estado !== 'completado' && orden.estado !== 'cancelado' ? 
                                                            `<button class="action-btn btn-pendiente" onclick="marcarComoPendiente('${orden.id}')">Pendiente</button>
                                                             <button class="action-btn btn-proceso" onclick="cambiarEstado('${orden.id}', 'proceso')">En Proceso</button>
                                                             <button class="action-btn btn-complete" onclick="cambiarEstado('${orden.id}', 'completado')">Completar</button>
                                                             <button class="action-btn btn-cancel" onclick="cancelarOrden('${orden.id}')">Cancelar</button>` : ''}
                                                        ${orden.estado === 'cancelado' && orden.comunicacionJefe && orden.comunicacionJefe.length > 0 ? 
                                                            `<button class="action-btn btn-reactivar" onclick="reactivarOrden('${orden.id}')">Reactivar</button>` : ''}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                // Para los jefes: mostrar solo las √≥rdenes de su √°rea
                let ordenesFiltradas = ordenes.filter(o => o.area === currentArea);
                
                // Ordenar por timestamp descendente (m√°s recientes primero)
                ordenesFiltradas.sort((a, b) => b.timestamp - a.timestamp);
                
                ordenesContent.innerHTML = `
                    <h2 class="${currentArea === 'proceso' ? 'proceso' : ''}">√ìrdenes de Trabajo - ${currentArea === 'proceso' ? 'Proceso' : 'Producci√≥n'}</h2>
                    <table class="orders-table ${currentArea === 'proceso' ? 'proceso' : ''}">
                        <thead>
                            <tr>
                                <th>No. Orden</th>
                                <th>M√°quina/Equipo</th>
                                <th>Descripci√≥n</th>
                                <th>Prioridad</th>
                                <th>Fecha Prometida</th>
                                <th>Estado</th>
                                <th>√öltima Actualizaci√≥n</th>
                                <th>Completada/Cancelada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordenesFiltradas.length === 0 ? 
                                '<tr><td colspan="9" class="empty-message">No hay √≥rdenes asignadas</td></tr>' : 
                                ordenesFiltradas.map(orden => {
                                    const estadoClass = `status-${orden.estado}`;
                                    const prioridadClass = `status-${orden.prioridad}`;
                                    
                                    let ultimaActualizacion = 'N/A';
                                    if (orden.fechaCompletado) {
                                        ultimaActualizacion = `Completada: ${orden.fechaCompletado}`;
                                    } else if (orden.fechaCancelacion) {
                                        ultimaActualizacion = `Cancelada: ${orden.fechaCancelacion}`;
                                    } else if (orden.fechaProceso) {
                                        ultimaActualizacion = `En proceso: ${orden.fechaProceso}`;
                                    } else if (orden.fechaPendiente) {
                                        ultimaActualizacion = `Pendiente: ${orden.fechaPendiente}`;
                                    }

                                    let fechaFinal = 'N/A';
                                    if (orden.fechaCompletado) {
                                        fechaFinal = orden.fechaCompletado;
                                    } else if (orden.fechaCancelacion) {
                                        fechaFinal = orden.fechaCancelacion;
                                    }

                                    return `
                                        <tr>
                                            <td>${orden.id}</td>
                                            <td>${orden.maquina}</td>
                                            <td class="descripcion-completa">${orden.descripcion}</td>
                                            <td><span class="status-badge ${prioridadClass}">${orden.prioridad}</span></td>
                                            <td>${orden.fechaPrometida}</td>
                                            <td><span class="status-badge ${estadoClass}">${orden.estado}</span></td>
                                            <td>${ultimaActualizacion}</td>
                                            <td>${fechaFinal}</td>
                                            <td>
                                                <button class="action-btn btn-edit" onclick="abrirModalEdicion('${orden.id}')">Gestionar</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // Funci√≥n para cargar el formulario de nueva orden seg√∫n el √°rea
        function cargarFormularioNuevaOrden() {
            const nuevaOrdenContent = document.getElementById('nueva-orden').querySelector('.form-container');
            
            const isProceso = currentArea === 'proceso';
            const areaClass = isProceso ? 'proceso' : '';
            const btnClass = isProceso ? 'btn-primary proceso' : 'btn-primary';
            
            nuevaOrdenContent.innerHTML = `
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="solicitante">SOLICITANTE</label>
                            <input type="text" id="solicitante" value="${usuarios[currentUser].nombre}">
                        </div>
                        <div class="form-group">
                            <label for="responsable">RESPONSABLE</label>
                            <select id="responsable">
                                <option value="Benito Suarez">BENITO SUAREZ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maquina">M√ÅQUINA/EQUIPO</label>
                            <input type="text" id="maquina" required>
                        </div>
                        <div class="form-group">
                            <label for="prioridad">PRIORIDAD</label>
                            <select id="prioridad" required>
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <label for="descripcion">DESCRIPCI√ìN DEL PROBLEMA</label>
                    <textarea id="descripcion" required></textarea>
                </div>
                
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fechaPedido">FECHA Y HORA DEL PEDIDO</label>
                            <input type="datetime-local" id="fechaPedido">
                        </div>
                        <div class="form-group">
                            <label for="fechaPrometida">FECHA PROMETIDA</label>
                            <input type="date" id="fechaPrometida" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <label>TIPO DE MANTENIMIENTO</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="preventivo">
                            <label for="preventivo">PREVENTIVO</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="correctivo">
                            <label for="correctivo">CORRECTIVO</label>
                        </div>
                    </div>
                </div>
                
                ${isProceso ? `
                <div class="form-section">
                    <label for="linea">SALA DE PROCESO</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="salaAgua">
                            <label for="salaAgua">Sala de acondicionamiento de agua</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="salaJarabes1">
                            <label for="salaJarabes1">Sala de jarabes 1</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="salaJarabes2">
                            <label for="salaJarabes2">Sala de jarabes 2</label>
                        </div>
                    </div>
                </div>
                ` : `
                <div class="form-section">
                    <label for="linea">L√çNEA DE PRODUCCI√ìN</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="linea1">
                            <label for="linea1">L√çNEA #1</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="linea2">
                            <label for="linea2">L√çNEA #2</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="linea3">
                            <label for="linea3">L√çNEA #3</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="linea6">
                            <label for="linea6">L√çNEA #6</label>
                        </div>
                    </div>
                </div>
                `}
                
                <div class="form-section">
                    <label for="observaciones">OBSERVACIONES INICIALES</label>
                    <textarea id="observaciones"></textarea>
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" id="btnCancelar">Cancelar</button>
                    <button class="btn ${btnClass}" id="btnGuardar">Guardar Orden</button>
                </div>
            `;
            
            // Establecer fecha y hora actual
            const ahora = new Date();
            const fechaHoraLocal = new Date(ahora.getTime() - ahora.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('fechaPedido').value = fechaHoraLocal;
            
            // Agregar event listeners a los botones
            document.getElementById('btnGuardar').addEventListener('click', guardarNuevaOrden);
            document.getElementById('btnCancelar').addEventListener('click', cancelarFormulario);
        }

        //FUNCI√ìN CORREGIDA: Guardar nueva orden con contadores independientes
        function guardarNuevaOrden() {
            const solicitante = document.getElementById('solicitante').value;
            const responsable = document.getElementById('responsable').value;
            const maquina = document.getElementById('maquina').value;
            const prioridad = document.getElementById('prioridad').value;
            const descripcion = document.getElementById('descripcion').value;
            const fechaPedido = document.getElementById('fechaPedido').value;
            const fechaPrometida = document.getElementById('fechaPrometida').value;
            const preventivo = document.getElementById('preventivo').checked;
            const correctivo = document.getElementById('correctivo').checked;
            const observaciones = document.getElementById('observaciones').value;
            
            if (!maquina || !descripcion || !fechaPrometida) {
                alert('Por favor, complete todos los campos obligatorios');
                return;
            }
            
            let lineas = [];
            if (currentArea === 'proceso') {
                if(document.getElementById('salaAgua').checked) lineas.push('Sala de acondicionamiento de agua');
                if(document.getElementById('salaJarabes1').checked) lineas.push('Sala de jarabes 1');
                if(document.getElementById('salaJarabes2').checked) lineas.push('Sala de jarabes 2');
            } else {
                if(document.getElementById('linea1').checked) lineas.push('L√≠nea #1');
                if(document.getElementById('linea2').checked) lineas.push('L√≠nea #2');
                if(document.getElementById('linea3').checked) lineas.push('L√≠nea #3');
                if(document.getElementById('linea6').checked) lineas.push('L√≠nea #6');
            }
            
            //USAR LA NUEVA FUNCI√ìN CON CONTADORES INDEPENDIENTES
            const nuevaOrden = {
                id: generarNumeroOrden(currentArea), // Solo pasamos el √°rea
                solicitante,
                responsable,
                maquina,
                estado: 'pendiente',
                prioridad,
                descripcion,
                fechaPedido,
                fechaPrometida,
                tipoMantenimiento: preventivo ? (correctivo ? 'Preventivo y Correctivo' : 'Preventivo') : (correctivo ? 'Correctivo' : ''),
                lineas,
                observaciones,
                timestamp: Date.now(),
                fechaPendiente: obtenerFechaHoraActual(),
                area: currentArea,
                historial: [{
                    fecha: obtenerFechaHoraActual(),
                    descripcion: 'Orden creada',
                    detalles: `Creada por: ${solicitante}`
                }]
            };
            
            // Resto del c√≥digo permanece igual...
            // Guardar en Firebase
            ordenes.push(nuevaOrden);
            db.ref('ordenes').set(ordenes);
            
            // MEJORA 3: Incluir observaciones en la notificaci√≥n
            let mensajeNotificacion = `Se te ha asignado una nueva orden: ${nuevaOrden.id}`;
            if (observaciones) {
                mensajeNotificacion += `\nObservaciones: ${observaciones}`;
            }
            
            // Crear notificaci√≥n para el responsable
            crearNotificacion(
                'Nueva orden de trabajo asignada',
                mensajeNotificacion,
                prioridad === 'urgente' ? 'urgente' : 'general',
                'BENITO',
                currentArea,
                {
                    maquina: maquina,
                    descripcion: descripcion,
                    prioridad: prioridad,
                    fechaPrometida: fechaPrometida,
                    tipoMantenimiento: preventivo ? (correctivo ? 'Preventivo y Correctivo' : 'Preventivo') : (correctivo ? 'Correctivo' : ''),
                    lineas: lineas.join(', '),
                    observaciones: observaciones
                }
            );
            
            mostrarNotificacion(`Orden ${nuevaOrden.id} creada y asignada a ${responsable}`, 'info', currentArea);
            
            // Limpiar formulario
            document.getElementById('maquina').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('fechaPrometida').value = '';
            document.getElementById('preventivo').checked = false;
            document.getElementById('correctivo').checked = false;
            
            // Limpiar checkboxes seg√∫n el √°rea
            if (currentArea === 'proceso') {
                document.getElementById('salaAgua').checked = false;
                document.getElementById('salaJarabes1').checked = false;
                document.getElementById('salaJarabes2').checked = false;
            } else {
                document.getElementById('linea1').checked = false;
                document.getElementById('linea2').checked = false;
                document.getElementById('linea3').checked = false;
                document.getElementById('linea6').checked = false;
            }
            
            document.getElementById('observaciones').value = '';
        }

        // Funci√≥n para cancelar formulario
        function cancelarFormulario() {
            if(confirm('¬øEst√° seguro de que desea cancelar?')) {
                document.getElementById('maquina').value = '';
                document.getElementById('descripcion').value = '';
                document.getElementById('fechaPrometida').value = '';
                document.getElementById('preventivo').checked = false;
                document.getElementById('correctivo').checked = false;
                
                // Limpiar checkboxes seg√∫n el √°rea
                if (currentArea === 'proceso') {
                    document.getElementById('salaAgua').checked = false;
                    document.getElementById('salaJarabes1').checked = false;
                    document.getElementById('salaJarabes2').checked = false;
                } else {
                    document.getElementById('linea1').checked = false;
                    document.getElementById('linea2').checked = false;
                    document.getElementById('linea3').checked = false;
                    document.getElementById('linea6').checked = false;
                }
                
                document.getElementById('observaciones').value = '';
            }
        }

        // Funci√≥n para reactivar una orden cancelada
        function reactivarOrden(ordenId) {
            const ordenIndex = ordenes.findIndex(o => o.id === ordenId);
            if (ordenIndex !== -1) {
                const orden = ordenes[ordenIndex];
                orden.estado = 'pendiente';
                orden.fechaReactivacion = obtenerFechaHoraActual();
                
                // Agregar al historial
                if (!orden.historial) {
                    orden.historial = [];
                }
                orden.historial.push({
                    fecha: obtenerFechaHoraActual(),
                    descripcion: 'Orden reactivada por el responsable',
                    detalles: 'El responsable ha reactivado la orden basado en las actualizaciones del jefe'
                });

                // Guardar en Firebase
                db.ref('ordenes').set(ordenes);

                // Crear notificaci√≥n
                crearNotificacion(
                    `Orden ${ordenId} reactivada`,
                    `El responsable ha reactivado la orden basado en tus actualizaciones`,
                    'reactivacion',
                    orden.area === 'proceso' ? 'EDGAR' : 'RODRIGO',
                    orden.area
                );

                mostrarNotificacion(`Orden ${ordenId} reactivada`, 'info', orden.area);
                actualizarDashboard();
                actualizarTablaOrdenes();
            }
        }

        // Funci√≥n para marcar una orden como pendiente
        function marcarComoPendiente(ordenId) {
            const motivo = prompt('Ingrese el motivo por el cual la orden se encuentra pendiente:');
            if (motivo === null) return;
            
            const ordenIndex = ordenes.findIndex(o => o.id === ordenId);
            if (ordenIndex !== -1) {
                const orden = ordenes[ordenIndex];
                orden.estado = 'pendiente';
                orden.motivoPendiente = motivo;
                orden.fechaPendiente = obtenerFechaHoraActual();
                
                // Agregar al historial
                if (!orden.historial) {
                    orden.historial = [];
                }
                orden.historial.push({
                    fecha: obtenerFechaHoraActual(),
                    descripcion: 'Orden marcada como pendiente',
                    detalles: `Motivo: ${motivo}`
                });

                // Guardar en Firebase
                db.ref('ordenes').set(ordenes);
                
                // Crear notificaci√≥n para el jefe
                crearNotificacion(
                    `Orden ${ordenId} marcada como pendiente`,
                    `La orden ha sido marcada como pendiente. Motivo: ${motivo}`,
                    'pendiente',
                    orden.area === 'proceso' ? 'EDGAR' : 'RODRIGO',
                    orden.area
                );
                
                mostrarNotificacion(`Orden ${ordenId} marcada como pendiente`, 'info', orden.area);
                actualizarDashboard();
                actualizarTablaOrdenes();
            }
        }

        // Funci√≥n para cambiar el estado de una orden
        function cambiarEstado(ordenId, nuevoEstado) {
            const ordenIndex = ordenes.findIndex(o => o.id === ordenId);
            if (ordenIndex !== -1) {
                const orden = ordenes[ordenIndex];
                const estadoAnterior = orden.estado;
                orden.estado = nuevoEstado;
                
                // Registrar fecha/hora seg√∫n el estado
                const fechaActual = obtenerFechaHoraActual();
                if (nuevoEstado === 'proceso') {
                    orden.fechaProceso = fechaActual;
                } else if (nuevoEstado === 'completado') {
                    orden.fechaCompletado = fechaActual;
                } else if (nuevoEstado === 'pendiente') {
                    orden.fechaPendiente = fechaActual;
                }
                
                // Si no es "pendiente", limpiar el motivo
                if (nuevoEstado !== 'pendiente') {
                    orden.motivoPendiente = '';
                }
                
                // Agregar al historial
                if (!orden.historial) {
                    orden.historial = [];
                }
                orden.historial.push({
                    fecha: fechaActual,
                    descripcion: `Estado cambiado de ${estadoAnterior} a ${nuevoEstado}`
                });

                // Guardar en Firebase
                db.ref('ordenes').set(ordenes);
                
                // Crear notificaci√≥n para el jefe
                crearNotificacion(
                    `Orden ${ordenId} actualizada`,
                    `La orden ha cambiado de ${estadoAnterior} a ${nuevoEstado}`,
                    'info',
                    orden.area === 'proceso' ? 'EDGAR' : 'RODRIGO',
                    orden.area
                );
                
                mostrarNotificacion(`Has actualizado la orden ${ordenId} a ${nuevoEstado}`, 'info', orden.area);
                actualizarDashboard();
                actualizarTablaOrdenes();
            }
        }

        // Funci√≥n para cancelar una orden (con motivo)
        function cancelarOrden(ordenId) {
            const motivo = prompt('Ingrese el motivo de cancelaci√≥n:');
            if (motivo === null) return;
            
            const ordenIndex = ordenes.findIndex(o => o.id === ordenId);
            if (ordenIndex !== -1) {
                const orden = ordenes[ordenIndex];
                orden.estado = 'cancelado';
                orden.motivoCancelacion = motivo;
                orden.motivoPendiente = '';
                orden.fechaCancelacion = obtenerFechaHoraActual();
                
                // Agregar al historial
                if (!orden.historial) {
                    orden.historial = [];
                }
                orden.historial.push({
                    fecha: obtenerFechaHoraActual(),
                    descripcion: 'Orden cancelada',
                    detalles: `Motivo: ${motivo}`
                });

                // Guardar en Firebase
                db.ref('ordenes').set(ordenes);
                
                // Crear notificaci√≥n para el jefe
                crearNotificacion(
                    `Orden ${ordenId} cancelada`,
                    `La orden ha sido cancelada. Motivo: ${motivo}`,
                    'error',
                    orden.area === 'proceso' ? 'EDGAR' : 'RODRIGO',
                    orden.area
                );
                
                mostrarNotificacion(`Orden ${ordenId} cancelada`, 'error', orden.area);
                actualizarDashboard();
                actualizarTablaOrdenes();
            }
        }

        // Funci√≥n para crear notificaci√≥n
        function crearNotificacion(titulo, mensaje, tipo = 'general', destinatario = null, area = null, detalles = null) {
            const notificacion = {
                titulo,
                mensaje,
                timestamp: Date.now(),
                usuario: currentUser,
                tipo,
                destinatario: destinatario || currentUser,
                area: area || currentArea
            };
            
            // Agregar detalles si se proporcionan
            if (detalles) {
                notificacion.detalles = detalles;
            }
            
            const nuevaNotificacionRef = db.ref('notificaciones').push();
            notificacion.key = nuevaNotificacionRef.key;
            nuevaNotificacionRef.set(notificacion);
        }

        // Funci√≥n para eliminar una notificaci√≥n individual por clave
        function eliminarNotificacion(notificacionKey) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta notificaci√≥n?')) {
                db.ref('notificaciones/' + notificacionKey).remove();
            }
        }

        // Funci√≥n para limpiar solo las notificaciones del usuario actual
        function limpiarTodasLasNotificaciones() {
            if (confirm('¬øEst√° seguro de que desea eliminar TODAS sus notificaciones?')) {
                db.ref('notificaciones').once('value').then((snapshot) => {
                    const notifsData = snapshot.val();
                    if (notifsData) {
                        const updates = {};
                        Object.keys(notifsData).forEach(key => {
                            const notif = notifsData[key];
                            // Solo eliminar notificaciones del usuario actual
                            if (notif.destinatario === currentUser || notif.destinatario === usuarios[currentUser]?.nombre) {
                                updates['notificaciones/' + key] = null;
                            }
                        });
                        db.ref().update(updates);
                        mostrarNotificacion('Tus notificaciones han sido eliminadas', 'info');
                    }
                });
            }
        }

        // MODIFICAR EL EVENT LISTENER DEL LOGIN
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim().toUpperCase();
            const password = document.getElementById('password').value;
            const recordar = rememberMe.checked;
            
            if (verificarCredenciales(username, password)) {
                // Guardar sesi√≥n si el usuario lo desea
                guardarSesion(username, recordar);
                
                currentUser = username;
                currentRole = usuarios[username].role;
                currentArea = usuarios[username].area;
                currentUserSpan.textContent = usuarios[username].nombre;
                currentRoleSpan.textContent = currentRole === 'jefe' ? 
                    (currentArea === 'proceso' ? 'Jefe Proceso' : 'Jefe Producci√≥n') : 
                    'Responsable';
                
                if (currentArea === 'proceso') {
                    currentRoleSpan.classList.add('proceso');
                } else {
                    currentRoleSpan.classList.remove('proceso');
                }
                
                cargarContadores();
                
                if (currentRole === 'responsable') {
                    document.getElementById('tabNuevaOrden').classList.add('hidden');
                } else {
                    document.getElementById('tabNuevaOrden').classList.remove('hidden');
                    cargarFormularioNuevaOrden();
                }
                
                loginScreen.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                
                iniciarListenersFirebase();
                
                mostrarNotificacion(`Bienvenido ${usuarios[username].nombre}`, 'info', currentArea);
            } else {
                alert('Usuario o contrase√±a incorrectos');
            }
        });

        // MODIFICAR EL LOGOUT PARA LIMPIAR LA PERSISTENCIA
        logoutBtn.addEventListener('click', function() {
            cerrarSesionPersistente();
            currentUser = null;
            currentRole = null;
            currentArea = null;
            mainSystem.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginForm.reset();
            
            // Desconectar listeners de Firebase
            db.ref('ordenes').off();
            db.ref('notificaciones').off();
            db.ref('.info/connected').off();
        });

        // FUNCI√ìN PARA INICIAR LISTENERS DE FIREBASE (reutilizable)
        function iniciarListenersFirebase() {
            // Escuchar cambios en tiempo real de √≥rdenes
            db.ref('ordenes').on('value', (snapshot) => {
                ordenes = snapshot.val() || [];
                actualizarDashboard();
                actualizarTablaOrdenes();
            });
            
            // Escuchar cambios en tiempo real de notificaciones con clave
            db.ref('notificaciones').on('value', (snapshot) => {
                const notifsData = snapshot.val();
                if (notifsData) {
                    notificaciones = Object.entries(notifsData).map(([key, value]) => {
                        return { ...value, key: key };
                    });
                    
                    notificaciones.sort((a, b) => b.timestamp - a.timestamp);
                    actualizarNotificaciones();
                    
                    if (notificaciones.length > 0) {
                        const ultimaNotificacion = notificaciones[0];
                        if (ultimaNotificacion.destinatario === currentUser && 
                            ultimaNotificacion.timestamp > Date.now() - 10000) {
                            mostrarNotificacion(ultimaNotificacion.mensaje, ultimaNotificacion.tipo, ultimaNotificacion.area);
                        }
                    }
                } else {
                    notificaciones = [];
                    actualizarNotificaciones();
                }
            });
            
            // Monitorear estado de conexi√≥n
            db.ref('.info/connected').on('value', (snapshot) => {
                const isConnected = snapshot.val();
                connectionStatus.classList.toggle('offline', !isConnected);
                connectionText.textContent = isConnected ? 'Conectado' : 'Desconectado';
            });
        }

        // VERIFICAR SI HAY SESI√ìN AL CARGAR LA P√ÅGINA
        document.addEventListener('DOMContentLoaded', function() {
            if (!iniciarSesionAutomatica()) {
                // Si no hay sesi√≥n activa, mostrar el login normalmente
                loginScreen.classList.remove('hidden');
            }
        });

        // Event listeners para el modal de edici√≥n
        closeModal.addEventListener('click', cerrarModalEdicion);
        btnCancelarEdicion.addEventListener('click', cerrarModalEdicion);
        btnGuardarEdicion.addEventListener('click', guardarCambiosEdicion);
        btnEnviarComunicacion.addEventListener('click', enviarComunicacionJefe);

        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', function(event) {
            if (event.target === modalEditar) {
                cerrarModalEdicion();
            }
        });

        // Navegaci√≥n por pesta√±as
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                document.querySelectorAll('.nav-tab').forEach(t => {
                    t.classList.remove('active');
                    if (currentArea === 'proceso') {
                        t.classList.remove('proceso');
                    }
                });
                
                this.classList.add('active');
                if (currentArea === 'proceso') {
                    this.classList.add('proceso');
                }
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
                
                // Si se cambia a la pesta√±a de nueva orden, cargar el formulario
                if (tabId === 'nueva-orden' && currentRole === 'jefe') {
                    cargarFormularioNuevaOrden();
                }
            });
        });
    </script>
</body>
</html>